dist: trusty
before_install: ci/install-dependencies.sh
script: ci/run-build-and-tests.sh
sudo: required
language: c
cache: ccache
group: deprecated-2017Q4
git:
    depth: 2147483647
env:
    global:
      - SLEEP_A_BIT="sleep 0.2"
      - VERBOSE="1"

matrix:
  include:
    # works on Precise and Trusty
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-7
            - g++-7
            - build-essential
      env:
        - MATRIX_EVAL="export PREFIX=~/.local CC=gcc-7 CXX=g++-7"
        - VIRTUALENVWRAPPER_PYTHON="/usr/bin/python2"
        - VIRTUALENVWRAPPER_VIRTUALENV="/usr/bin/virtualenv2"
        - LIND_PREFIX="$HOME"
        - LIND_BASE="$LIND_PREFIX/lind_project"
        - LIND_SRC="$LIND_BASE/lind"
        - LIND_MONITOR="$LIND_BASE/reference_monitor"
        - REPY_PATH="$LIND_SRC/repy"
        - NACL_SDK_ROOT="$REPY_PATH/sdk"
        - PYTHON="python2"
        - PNACLPYTHON="python2"
        - LD_LIBRARY_PATH="/lib/glibc"
        - PATH="$NACL_SDK_ROOT/toolchain/linux_x86_glibc/bin:$PATH"
        - PATH="$REPY_PATH/bin:$PATH"
        - PATH="$LIND_BASE:$PATH"
        - PATH="$HOME/bin:$HOME/.local/bin:$PATH"

    # works on Precise and Trusty
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-6
            - g++-6
            - build-essential
      env:
        - MATRIX_EVAL="export PREFIX=~/.local CC=gcc-6 CXX=g++-6"
        - VIRTUALENVWRAPPER_PYTHON="/usr/bin/python2"
        - VIRTUALENVWRAPPER_VIRTUALENV="/usr/bin/virtualenv2"
        - LIND_PREFIX="$HOME"
        - LIND_BASE="$LIND_PREFIX/lind_project"
        - LIND_SRC="$LIND_BASE/lind"
        - LIND_MONITOR="$LIND_BASE/reference_monitor"
        - REPY_PATH="$LIND_SRC/repy"
        - NACL_SDK_ROOT="$REPY_PATH/sdk"
        - PYTHON="python2"
        - PNACLPYTHON="python2"
        - LD_LIBRARY_PATH="/lib/glibc"
        - PATH="$NACL_SDK_ROOT/toolchain/linux_x86_glibc/bin:$PATH"
        - PATH="$REPY_PATH/bin:$PATH"
        - PATH="$LIND_BASE:$PATH"
        - PATH="$HOME/bin:$HOME/.local/bin:$PATH"

    # works on Trusty
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - sourceline: "deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main"
          packages:
            - clang-6.0 lldb-6.0 lld-6.0
            - build-essential
      env:
        - MATRIX_EVAL="export PREFIX=~/.local CC=clang-6.0 CXX=clang++-6.0"
        - VIRTUALENVWRAPPER_PYTHON="/usr/bin/python2"
        - VIRTUALENVWRAPPER_VIRTUALENV="/usr/bin/virtualenv2"
        - LIND_PREFIX="$HOME"
        - LIND_BASE="$LIND_PREFIX/lind_project"
        - LIND_SRC="$LIND_BASE/lind"
        - LIND_MONITOR="$LIND_BASE/reference_monitor"
        - REPY_PATH="$LIND_SRC/repy"
        - NACL_SDK_ROOT="$REPY_PATH/sdk"
        - PYTHON="python2"
        - PNACLPYTHON="python2"
        - LD_LIBRARY_PATH="/lib/glibc"
        - PATH="$NACL_SDK_ROOT/toolchain/linux_x86_glibc/bin:$PATH"
        - PATH="$REPY_PATH/bin:$PATH"
        - PATH="$LIND_BASE:$PATH"
        - PATH="$HOME/bin:$HOME/.local/bin:$PATH"

before_install:
    - eval "$MATRIX_EVAL"
    - sudo apt-get install -qq --allow-unauthenticated --fix-missing gettext gperf texinfo coreutils
    - sudo apt-get install -qq --allow-unauthenticated --fix-missing linux-headers-generic linux-libc-dev
    - sudo apt-get install -qq --allow-unauthenticated --fix-missing virtualenvwrapper help2man
    # - sudo apt-get install -qq --fix-missing

script:
    - ln -Tsfv "$PWD" "$LIND_BASE"
    - cd "$LIND_BASE/docker/base/home/lind/build/make-3.82/src/make-3.82/"
    - ./configure --prefix="$HOME/.local"
    - make -k -i install
    - cd "$LIND_BASE/docker/base/home/lind/build/texinfo-4.13/"
    - make -k -i install
    - cd "$LIND_BASE"
    - ./mklind -e download
    - ./mklind -e nacl
    - ./mklind -e repy
    - ./mklind -e glibc
    - ./mklind -e install

wget ftp://ftp.gnu.org/gnu/gmp/gmp-5.1.3.tar.gz
wget ftp://ftp.gnu.org/gnu/mpfr/mpfr-3.1.2.tar.gz
wget https://ftp.gnu.org/gnu/mpc/mpc-1.0.1.tar.gz
tar -zxvf gmp-5.1.3.tar.gz
tar -zxvf mpfr-3.1.2.tar.gz
tar -zxvf mpc-1.0.1.tar.gz
mv gmp-5.1.3 gmp
mv mpc-1.0.1 mpc
mv mpfr-3.1.2 mpfr
cd ../
mkdir build-gcc
cd build-gcc/
../gcc-4.4.3/configure CC=gcc CFLAGS='-fgnu89-inline -g -O2' CXXFLAGS='-fgnu89-inline -g -O2' --prefix=/usr/local/gcc-4.4.3/ --enable-checking=release --enable-languages=c,c++ --disable-multili

# Modify linux-unwind.h
linuxfile="../gcc-4.4.3/gcc/config/i386/linux-unwind.h"

if [ ! -f "$linuxfile" ]; then
  echo "File $linuxfile not exist"
  exit 1
fi

temp_file=$(mktemp)

awk '{
  if (NR == 136) { print "siginfo_t *pinfo;" }
  else if (NR == 138) { print "siginfo_t info;" }
  else if (NR == 139) { print "ucontext_t uc;" }
  else if (NR == 50) { print "ucontext_t *uc_ = context->cfa;" }
  else { print $0 }
}' "$linuxfile" > "$temp_file"

mv "$temp_file" "$linuxfile"

# Modify Makefile
makefile_path="Makefile"

if [ ! -f "$makefile_path" ]; then
  echo "File $makefile_path not exist"
  exit 1
fi

temp_file2=$(mktemp)

awk '{
  if ($1 == "CC" && $3 == "gcc") { print "CC = gcc -fgnu89-inline" }
  else if ($1 == "CXX" && $3 == "g++") { print "CXX = g++ -fgnu89-inline" }
  else { print $0 }
}' "$makefile_path" > "$temp_file2"

mv "$temp_file2" "$makefile_path"

make -j8
sudo make install
